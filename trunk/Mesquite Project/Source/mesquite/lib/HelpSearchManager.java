/* Mesquite source code.  Copyright 2001-2006 D. Maddison and W. Maddison. Version 1.11, June 2006.Disclaimer:  The Mesquite source code is lengthy and we are few.  There are no doubt inefficiencies and goofs in this code. The commenting leaves much to be desired. Please approach this source code with the spirit of helping out.Perhaps with your help we can be more than a few, and make Mesquite better.Mesquite is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.Mesquite's web site is http://mesquiteproject.orgThis source code and its compiled class files are free and modifiable under the terms of GNU Lesser General Public License.  (http://www.gnu.org/copyleft/lesser.html) */package mesquite.lib;import java.util.Vector;import javax.swing.JEditorPane;import javax.swing.JScrollPane;import javax.swing.event.HyperlinkListener;import mesquite.lib.duties.WindowHolder;/* acts on Mesquite trunk's behalf to manage searchable help system */public class HelpSearchManager implements Commandable {	MesquiteModule searchWindowBabysitter;	boolean showExplanation = false;	MesquiteModuleInfo currentModule;	MesquiteCommand selectionCommand = new MesquiteCommand(null, null);	/*.................................................................................................................*/	public Object doCommand(String commandName, String arguments, CommandRecord commandRec, CommandChecker checker) {		if (checker.compare(this.getClass(), "Hypertext link has been touched", "[link text]", commandName, "linkTouched")) {			linkTouched(searchParser.getFirstToken(arguments));		}		return null;	}	public void makeWindow(){		if (searchWindowBabysitter != null)			return;		searchWindowBabysitter = MesquiteTrunk.mesquiteTrunk.hireNamedEmployee (CommandRecord.getRecSIfNull(), WindowHolder.class, "#WindowBabysitter");		HSWindow ww = new HSWindow(searchWindowBabysitter, new MesquiteCommand("linkTouched", this), "Search", true);		searchWindowBabysitter.setModuleWindow(ww);		//	ww.setWindowSize(620, 400, false);	}	public void showHTML(String s){		if (searchWindowBabysitter== null)			makeWindow();		if (searchWindowBabysitter.getModuleWindow()!= null){			MesquiteHTMLWindow w = (MesquiteHTMLWindow)searchWindowBabysitter.getModuleWindow();			if (w != null){				w.setText(s);				w.setVisible(true);				w.show();			}		}	}	/*.................................................................................................................*/	public void searchData(String s, MesquiteWindow window, CommandRecord commandRec){		if (window == null)			return;		MesquiteString commandResult = new MesquiteString();		/*if (searchWindowBabysitter == null) {			String results = window.searchData(s, commandResult, commandRec);			if (results != null){				searchWindowBabysitter = MesquiteTrunk.mesquiteTrunk.hireNamedEmployee (commandRec, WindowHolder.class, "#WindowBabysitter");				MesquiteHTMLWindow ww = new MesquiteHTMLWindow(searchWindowBabysitter, new MesquiteCommand("linkTouched", this), "Search results", true);				searchWindowBabysitter.setModuleWindow(ww);				searchWindowBabysitter.resetContainingMenuBar();				MesquiteTrunk.resetAllWindowsMenus();				ww.setWindowSize(620, 400);				ww.setDataWindow(window);				ww.setText(results);				if (commandResult.isBlank()){					ww.setVisible(true);				}			}			if (!commandResult.isBlank()){				String description = commandResult.getValue();				selectionCommand.setOwner(window);				selectionCommand.setCommandName(description.substring(0, description.indexOf(":")));				selectionCommand.doIt(description.substring(description.indexOf(":")+1, description.length()));			}		}		else */ if (searchWindowBabysitter.getModuleWindow()!= null){			MesquiteHTMLWindow w = (MesquiteHTMLWindow)searchWindowBabysitter.getModuleWindow();			String results = null;			if (w == window && w.getDataWindow() != null) //another query in results window				results = w.getDataWindow().searchData(s, commandResult, commandRec);			else				results = window.searchData(s, commandResult, commandRec);			if (window != w)				w.setDataWindow(window);			if (results != null){				w.setText(results);				if (commandResult.isBlank())					w.show();			}			if (!commandResult.isBlank()){				if (w.getDataWindow() != null){					String description = commandResult.getValue();					selectionCommand.setOwner(w.getDataWindow());					selectionCommand.setCommandName(description.substring(0, description.indexOf(":")));					selectionCommand.doIt(description.substring(description.indexOf(":")+1, description.length()));				}			}		}	}	/*.................................................................................................................*/	public void searchKeyword(String s, boolean useBrowser, CommandRecord commandRec){		String results = "";		//Pattern pattern = Pattern.compile(s, Pattern.CASE_INSENSITIVE);		MesquiteModuleInfo mbi = null;		MesquiteInteger lastIndex =  new MesquiteInteger(-1);		MesquiteInteger category = new MesquiteInteger(0);		while ((mbi = (MesquiteModuleInfo)MesquiteTrunk.mesquiteModulesInfoVector.getNextModule(lastIndex, category))!=null){			//if (stringFound(mbi.getName(), pattern) || stringFound(mbi.getExplanation(), pattern)) // || stringFound(mbi.getCitation())			//	results += keywordInfo(mbi, s, useBrowser); 			if (mbi.getSearchableAsModule() && (stringsFound(mbi.getName(), s) || stringsFound(mbi.getExplanation(), s) || stringsFound(mbi.getKeywords(), s))) // || stringFound(mbi.getCitation())				results += keywordInfo(mbi, s, useBrowser); 		}		if (StringUtil.blank(results))			results = ("<h2>No module with keywords found (searched: \"" + stringsSearched(s) + "\")</h2>");		else 			results = "<h2>Modules found (searched: \"" + stringsSearched(s) + "\")</h2>Click the links to see how these functions may be accessed and other details.<ul>" + results + "</ul>";		if (useBrowser){			MesquiteFile.putFileContents(MesquiteModule.prefsDirectory + MesquiteFile.fileSeparator + "tempKeywordSearch.html", results, true);			MesquiteModule.showWebPage(MesquiteModule.prefsDirectory + MesquiteFile.fileSeparator + "tempKeywordSearch.html", true);		}		else {			/*if (searchWindowBabysitter == null) {				searchWindowBabysitter = MesquiteTrunk.mesquiteTrunk.hireNamedEmployee (commandRec, WindowHolder.class, "#WindowBabysitter");				MesquiteHTMLWindow ww = new MesquiteHTMLWindow(searchWindowBabysitter, new MesquiteCommand("linkTouched", this), "Search results", true);				searchWindowBabysitter.setModuleWindow(ww);				searchWindowBabysitter.resetContainingMenuBar();				MesquiteTrunk.resetAllWindowsMenus();				ww.setDataWindow(null);				ww.setWindowSize(620, 400);				ww.setText(results);				ww.setVisible(true);			}			else*/ if (searchWindowBabysitter.getModuleWindow()!= null){				MesquiteHTMLWindow w = (MesquiteHTMLWindow)searchWindowBabysitter.getModuleWindow();				w.setDataWindow(null);				w.setText(results);				w.setVisible(true);			}		}	}	public void employeeQuit(MesquiteModule mb){		if (mb == searchWindowBabysitter)			searchWindowBabysitter = null;	}	private boolean isNeeded(MesquiteModuleInfo mmi){		Vector v = MesquiteTrunk.mesquiteModulesInfoVector.whoUsesMe(mmi);		return !(v == null || v.size() == 0);	}	String howRef = null;	Vector toc = new Vector();	boolean showTOC = false;	private String needChainUserForward(MesquiteModuleInfo mmi, MesquiteModuleInfo employee, boolean mmiListingSuppressed, int depth, String spacer, Vector chain, int maxDepth){		if (chain.indexOf(mmi)>=0) { //to prevent infinite recursion, e.g. for random tree modifiers			//		Debugg.println(">>>>>>>>>>>>>>>>mmi " + mmi.getClassName());			return null;		}		if (depth > maxDepth){			return "AND MORE";		}//		if (mmi != null) Debugg.println(spacer + depth + " " + mmi.getClassName());		/*	if (depth == 1)Debugg.println(">>>>>>>>>>>>>>>>>>>>>>>>>>>");		Debugg.println("" + depth + ">>>>>>>>>>>>>>>>>>>>>>>>>>>");		if (mmi != null) Debugg.println(">>>>>>mmi " + mmi.getClassName());		if (employee != null) Debugg.println("-------employee " + employee.getClassName());*/		Vector v = MesquiteTrunk.mesquiteModulesInfoVector.whoUsesMe(mmi);		if (v == null || v.size() == 0)			return "";		String s = "";		chain.addElement(mmi);		for (int i = 0; i< v.size() && countUses<maxCount; i++){			EmployeeNeed en = (EmployeeNeed)v.elementAt(i);			String sc = "";			if (en.getSuppressListing()){				/*if (en.getDivertChainMessage() != null)					sc = "<strong>DIVERTED</strong>";				else */				if (en.isEntryPoint()){					countUses++;					sc = en.getAccessPoint();				}				else					sc =  needChainUserForward(en.getRequestor(), mmi, true, depth, spacer, chain, maxDepth);			}			else {				/* if (en.getDivertChainMessage() != null)					sc = "<strong>DIVERTED</strong>";				else */ if (en.isEntryPoint()){					countUses++;					sc = en.getAccessPoint();				}				else					sc =  needChainUserForward(en.getRequestor(), mmi, false, depth +1, spacer + "  ", chain, maxDepth);				if (StringUtil.blank(sc))					sc = "";				else if (!en.isEntryPoint())// && en.getDivertChainMessage() == null)					sc =  "<ul>" + sc + "</ul>";				if (!en.isEntryPoint()){// && en.getDivertChainMessage() == null){					if (depth >0){						if (i == 0){							if (mmiListingSuppressed)								s += "<li>This is available through ";							else								s += "<li>" + mmi.getName() + " is available through ";						}						else {							if (mmiListingSuppressed)								s += "<li>This is also available through ";							else								s += "<li>" + mmi.getName() + " is also available through ";						}					}					else {						if (i != 0)							s += "<br>";						s += "<li>Via ";					}					String requestorName = en.getRequestor().getName();					if (en.getAlternativeEmployerLabel() != null)						requestorName = en.getAlternativeEmployerLabel();					if (depth == 0){						if (showTOC)							s += "<a name = \"" + toc.size() + "\"></a>";						toc.addElement("<li>" + requestorName+ "</li>");						//	toc.addElement("<li><a href = \"#" + toc.size() + "\">" + en.getRequestor().getName() + "</a></li>");						s+= "<font size = +1>";					}					s +=  "<strong>" +requestorName + ".</strong> ";					if (depth ==0)						s+= "</font>";					if (showExplanation)						s += en.getExplanation();					if (mmiListingSuppressed)						s +="&nbsp;" + howRef + "&nbsp; " /*<strong>How to access this:</strong> "*/ + en.getAccessPoint() ;					else						s += "&nbsp;" + howRef + "&nbsp; " /*<strong>How to access " + mmi.getName() + ":</strong> " */ + en.getAccessPoint() ;					s += "</li>";				}			}			s += sc;		}		chain.removeElement(mmi);		return s;	}	int countUses= 0;	private void countChainUserForward(MesquiteModuleInfo mmi, boolean mmiListingSuppressed, Vector chain, int depth, int maxDepth){		if (chain.indexOf(mmi)>=0) { //to prevent infinite recursion, e.g. for random tree modifiers			return;		}		if (depth > maxDepth){			return;		}		Vector v = MesquiteTrunk.mesquiteModulesInfoVector.whoUsesMe(mmi);		if (v == null || v.size() == 0){			return;		}		chain.addElement(mmi);		for (int i = 0; i< v.size() && countUses<maxCount; i++){			EmployeeNeed en = (EmployeeNeed)v.elementAt(i);			if (en.getSuppressListing()){				if (en.isEntryPoint()){					countUses++;					if (countUses % 1000 == 0)						Debugg.println("uses " + countUses);				}				else					countChainUserForward(en.getRequestor(), true, chain, depth, maxDepth);			}			else {				if (en.isEntryPoint()){					countUses++;					if (countUses % 1000 == 0)						Debugg.println("uses " + countUses);				}				else					countChainUserForward(en.getRequestor(), false, chain, depth+1, maxDepth);			}		}		chain.removeElement(mmi);	}	/*------*/	int maxCount = 200;	/*------*/	private void showModuleUse(MesquiteHTMLWindow w, MesquiteModuleInfo mmi){		toc.setSize(0);		Vector chain = new Vector();		countUses = 0;		maxCount = 100;		String userChain = needChainUserForward(mmi, null, false, 0, "", chain, 9999999);		String intro = "<html><h2>" + mmi.getName() + "</h2><font size = +1>" + mmi.getExplanation() + "</font>";		if (countUses>= maxCount)			intro += "<h2>NOTE: other use scenarios were found but are too numerous to list</h2";		String needs = "";		if (toc.size()>0){			if (showTOC){				intro  += "<p><a name = \"#top\"></a><strong>" + mmi.getName() + "</strong> can be accessed here:<ul>";				for (int i = 0; i<toc.size(); i++){					intro += (String)toc.elementAt(i);				}				intro += "</ul>";			}			if (mmi.hasNeeds())				needs = "<h3>" + mmi.getName() + " <a href = \"moduleNeeds:" +mmi.getClassName()+ "\">makes use of other modules or functions</a></h3>";			intro += "<p></p><hr>";			if (showExplanation)				intro += "<a href = \"hideExplanation:\">Hide explanations</a>";			else				intro += "<a href = \"showExplanation:\">Show explanations</a>";			intro += "<h2>How To Access:</h2>";		}		w.setText(intro + "<ul>" + userChain + "</ul><hr>" + needs + "</html>");		w.setVisible(true);	}	private void showModuleNeeds(MesquiteHTMLWindow w, MesquiteModuleInfo mmi){		toc.setSize(0);		String intro = "<html><h2>Other modules or functions used by " + mmi.getName() + "</h2>" + mmi.getExplanation();		String needs = "<ul>";		if (mmi.hasNeeds()){			Vector v = mmi.getEmployeeNeedsVector();			for (int i = 0; i<v.size(); i++){				EmployeeNeed e = (EmployeeNeed)v.elementAt(i);				needs += "<li>" + e.getExplanation() + e.getAccessPoint() + " The available modules to serve this need are as follows.  (NOTE: some of these might be unavailable in certain contexts, for instance if incompatible with a particular sort of data):<ul>";				MesquiteModuleInfo possibleEmployee = null;				boolean start = true;				while (start || possibleEmployee != null){					possibleEmployee = MesquiteTrunk.mesquiteModulesInfoVector.findNextModule(e.getDutyClass(), possibleEmployee, null, null, null);					start = false;					if (possibleEmployee != null) {						if (possibleEmployee.hasNeeds())							needs += "<li><a href = \"moduleNeeds:" + possibleEmployee.getClassName() + "\"><strong>"+ possibleEmployee.getName() + "</strong></a> " + possibleEmployee.getExplanation() + "</li>";						else							needs += "<li><strong>"+ possibleEmployee.getName() + "</strong> " + possibleEmployee.getExplanation() + "</li>";					}				}				needs += "</ul></li>";			}		}		/*		if (toc.size()>0){			intro  += " <a name = \"#top\"></a>This function can be accessed in the following places:<ul>";			for (int i = 0; i<toc.size(); i++){				intro += (String)toc.elementAt(i);			}			intro += "</ul>";			if (mmi.hasNeeds())				intro += "This function in turn <a href = \"moduleNeeds:" +mmi.getClassName()+ "\">makes use of various other functions</a>";				if (showExplanation)					intro += "<a href = \"hideExplanation:\">Hide explanations</a>";				else		intro += "<a href = \"showExplanation:\">Show explanations</a>";				intro += "<hr><h3>Access:</hr>";		}		w.setText(intro + "<ul>" + userChain + "</ul></html>");		 */		w.setText(intro + needs + "</html>");		w.setVisible(true);	}	private void linkTouched(String description){		if (searchWindowBabysitter != null && searchWindowBabysitter.getModuleWindow() != null && description != null){			if (howRef == null)				howRef = "<img src = \"" + MesquiteFile.massageFilePathToURL(MesquiteModule.getRootImageDirectoryPath() + "how.gif") + "\">";			MesquiteHTMLWindow w = (MesquiteHTMLWindow)searchWindowBabysitter.getModuleWindow();			if (description.startsWith("moduleUse:")){				String mName = description.substring(description.indexOf(":")+1, description.length());				MesquiteModuleInfo mmi = MesquiteTrunk.mesquiteModulesInfoVector.findModule(MesquiteModule.class, mName);				if (mmi != null){					currentModule = mmi;					showModuleUse(w, mmi);				}			}			else if (description.startsWith("hideExplanation:")){				showExplanation = false;				showModuleUse(w, currentModule);			}			else if (description.startsWith("showExplanation:")){				showExplanation = true;				showModuleUse(w, currentModule);			}			else if (description.startsWith("moduleNeeds:")){				String mName = description.substring(description.indexOf(":")+1, description.length());				MesquiteModuleInfo mmi = MesquiteTrunk.mesquiteModulesInfoVector.findModule(MesquiteModule.class, mName);				if (mmi != null){					currentModule = mmi;					showModuleNeeds(w, mmi);				}			}			else if (searchWindowBabysitter.getModuleWindow()!= null) {				MesquiteHTMLWindow ww = (MesquiteHTMLWindow)searchWindowBabysitter.getModuleWindow();				if (ww.getDataWindow() != null){					selectionCommand.setOwner(ww.getDataWindow());					selectionCommand.setCommandName(description.substring(0, description.indexOf(":")));					selectionCommand.doIt(description.substring(description.indexOf(":")+1, description.length()));				}			}		}	}	/*	private boolean stringFound(String s, Pattern pattern){		Matcher matcher =   pattern.matcher(s);			return matcher.find();	}	 */	/*.................................................................................................................*/	Parser searchParser = new Parser();	private String stringsSearched(String targets){		if (StringUtil.blank(targets))			return "";		String conjunction = " OR ";		if (HelpSearchStrip.searchMODE == HelpSearchStrip.searchAND)			conjunction = " AND ";		String token = searchParser.getFirstToken(targets);		boolean first = true;		String result = "";		while (!StringUtil.blank(token)){			if (!first)				result += conjunction;			result += token;			first = false;			token = searchParser.getNextToken();		}		return result;	}	/*.................................................................................................................*/	private boolean stringsFound(String s, String targets){		if (s == null || StringUtil.blank(targets))			return false;		String lcS = s.toLowerCase();		if (HelpSearchStrip.searchMODE == HelpSearchStrip.searchAND){			String token = searchParser.getFirstToken(targets);			while (!StringUtil.blank(token)){				if (!stringFound(lcS, token))					return false;				token = searchParser.getNextToken();			}			return true;		}		else {			String token = searchParser.getFirstToken(targets);			while (!StringUtil.blank(token)){				if (stringFound(lcS, token))					return true;				token = searchParser.getNextToken();			}			return false;		}	}	/*.................................................................................................................*/	private boolean stringFound(String s, String target){		if (s == null || target == null)			return false;		String lcS = s.toLowerCase();		return (lcS.indexOf(target)>=0);	}	/*.................................................................................................................*/	private String keywordInfo(MesquiteModuleInfo mbi, String target, boolean forBrowser){		String nameString = "<li>";		if (!forBrowser) {			if (isNeeded(mbi))				nameString += "<a href =\"moduleUse:" + mbi.getClassName() + "\">" + mbi.getName() + "</a>";			else				nameString += mbi.getName();			return nameString + ":  " + mbi.getExplanation() + StringUtil.lineEnding() + StringUtil.lineEnding(); 		}		else {			String gcp = MesquiteFile.massageFilePathToURL(MesquiteModule.prefsDirectory + MesquiteFile.fileSeparator + "commands" + MesquiteFile.fileSeparator + mbi.getShortClassName() + ".html");			if (StringUtil.blank(gcp))				nameString += mbi.getName();			else				nameString += "<a href =\"" + gcp + "\">" + mbi.getName() + "</a>";			return nameString + ":  " + mbi.getExplanation() + StringUtil.lineEnding() + StringUtil.lineEnding(); 		}	}}class HSWindow extends MesquiteHTMLWindow implements SystemWindow {	public HSWindow(MesquiteModule module, MesquiteCommand linkTouchedCommand, String assignedTitle, boolean showInfoBar) {		super(module, linkTouchedCommand, assignedTitle, showInfoBar);	}	public boolean showInfoTabs(){		return false;	}}