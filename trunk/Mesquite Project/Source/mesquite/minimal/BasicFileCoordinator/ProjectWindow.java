/* Mesquite source code.  Copyright 1997-2007 W. Maddison and D. Maddison.Version 2.01, December 2007.Disclaimer:  The Mesquite source code is lengthy and we are few.  There are no doubt inefficiencies and goofs in this code. The commenting leaves much to be desired. Please approach this source code with the spirit of helping out.Perhaps with your help we can be more than a few, and make Mesquite better.Mesquite is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.Mesquite's web site is http://mesquiteproject.orgThis source code and its compiled class files are free and modifiable under the terms of GNU Lesser General Public License.  (http://www.gnu.org/copyleft/lesser.html) */package mesquite.minimal.BasicFileCoordinator;/*~~  */import java.util.*;import java.awt.*;import java.awt.event.*;import mesquite.lib.*;import mesquite.lib.characters.CharacterData;import mesquite.lib.duties.*;import mesquite.categ.lib.*;import mesquite.cont.lib.*;public class ProjectWindow extends MesquiteWindow implements MesquiteListener {	MesquiteProject proj;	boolean suppressed = false;	BasicFileCoordinator bfc;	ProjectPanel panel;	/*.................................................................................................................*/	public ProjectWindow(FileCoordinator  ownerModule){		super(ownerModule, false);		bfc = (BasicFileCoordinator)ownerModule;		proj = ownerModule.getProject();		panel = new ProjectPanel(this, proj, bfc);		addToWindow(panel);		proj.addListener(this);	}	public int getDefaultTileLocation(){		return MesquiteFrame.RESOURCES;	}	public void windowResized(){		if (panel != null)			panel.setBounds(0,0,getBounds().width, getBounds().height);	}	/*.................................................................................................................*/	public void resetTitle(){		if (ownerModule==null || ownerModule.getProject() == null)			setTitle("Project");		else			setTitle(ownerModule.getProject().getName());	}	public boolean showInfoTabs(){		return false;	}	public void dispose(){		panel.dispose();		super.dispose();	}	/** passes which object changed, along with optional Notification object with details (e.g., code number (type of change) and integers (e.g. which character))*/	public void changed(Object caller, Object obj, Notification notification){		if (obj == proj && !MesquiteThread.isScripting()){			panel.refresh();		}	}	public void refresh(){		panel.refresh();	}	void suppress(){		suppressed = true;		proj.incrementProjectWindowSuppression();	}	void resume(){  //BECAUSE OF decPWS below, should call this only if suppress had been called previously		resume(true);	}	void resume(boolean dpws){  		suppressed = false;		if (dpws)			proj.decrementProjectWindowSuppression();		refresh();	}}class ProjectPanel extends Panel implements ClosablePanelContainer{	Vector elements = new Vector();	MesquiteProject proj;	BasicFileCoordinator bfc;	ProjectWindow w;	public ProjectPanel(ProjectWindow w, MesquiteProject proj, BasicFileCoordinator bfc){ 		super();		this.w = w;		this.bfc = bfc;		this.proj = proj;		setLayout(null);		setBackground(Color.white);		//	setBackground(ColorDistribution.veryVeryLightGray);	}	public void requestHeightChange(ClosablePanel panel){		resetSizes(getBounds().width, getBounds().height);	}	public void dispose(){		if (true)			return;		for (int i = 0; i<elements.size(); i++){			ClosablePanel panel = ((ClosablePanel)elements.elementAt(i));			remove(panel);			panel.dispose();		}	}	public ClosablePanel getPrecedingPanel(ClosablePanel panel){		return null;	}	void addExtraPanel(ElementPanel p){		elements.addElement(p);		add(p);		resetSizes(getWidth(), getHeight());		p.setVisible(true);	}	void resetSizes(int w, int h){		int vertical = 2;		for (int i = 0; i<elements.size(); i++){			ClosablePanel panel = ((ClosablePanel)elements.elementAt(i));			int requestedlHeight = panel.getRequestedHeight(w);			panel.setBounds(0, vertical, w, requestedlHeight);			vertical += requestedlHeight;		}	}	public void setBounds(int x, int y, int w, int h){		super.setBounds(x,y,w,h);		resetSizes(w, h);	}	public void setSize(int w, int h){		super.setSize(w,h);		resetSizes(w, h);	}		int count = 0;	boolean sequenceUpToDate(){		int e = 0;		if (proj.taxas.size()>0){			for (int i = 0; i< proj.taxas.size(); i++){				Taxa t = (Taxa)proj.taxas.elementAt(i);				if (e>= elements.size())					return false;				ElementPanel panel = ((ElementPanel)elements.elementAt(e));				if (panel.element != t)					return false;				e++;				if (proj.getNumberCharMatrices(t)>0){					for (int k = 0; k<proj.getNumberCharMatrices(t); k++){						CharacterData data = proj.getCharacterMatrix(t, k);						if (e>= elements.size())							return false;						panel = ((ElementPanel)elements.elementAt(e));						if (panel.element != data)							return false;						e++;					}				}				if (proj.getNumberOfFileElements(TreeVector.class)>0){					for (int k = 0; k<proj.getNumberOfFileElements(TreeVector.class); k++){						TreeVector trees = (TreeVector)proj.getFileElement(TreeVector.class, k);						if (e>= elements.size())							return false;						panel = ((ElementPanel)elements.elementAt(e));						if (panel.element != trees)							return false;						e++;					}				}			}			if (e<elements.size())				return false;			return true;		}		else if (elements.size() != 0)			return false;		return true;	}	public void refresh(){		if (sequenceUpToDate())			return;		for (int i = 0; i<elements.size(); i++){			ClosablePanel panel = ((ClosablePanel)elements.elementAt(i));			remove(panel);			panel.dispose();		}		elements.removeAllElements();		ElementPanel panel = null;		if (proj.taxas.size()>0){			for (int i = 0; i< proj.taxas.size(); i++){				Taxa t = (Taxa)proj.taxas.elementAt(i);				addExtraPanel(panel = new TaxaPanel(bfc, this, t));				panel.setLocation(0,0);				if (proj.getNumberCharMatrices(t)>0){					for (int k = 0; k<proj.getNumberCharMatrices(t); k++){						CharacterData data = proj.getCharacterMatrix(t, k);						if (data instanceof MolecularData)							addExtraPanel(panel = new MolecMPanel(bfc, this, data));						else if (data instanceof ContinuousData)							addExtraPanel(panel = new ContMPanel(bfc, this, data));						else							addExtraPanel(panel = new CategMPanel(bfc, this, data));						panel.setLocation(0,0);					}				}				if (proj.getNumberOfFileElements(TreeVector.class)>0){					for (int k = 0; k<proj.getNumberOfFileElements(TreeVector.class); k++){						TreeVector trees = (TreeVector)proj.getFileElement(TreeVector.class, k);						if (trees.getTaxa() == t){							addExtraPanel(panel = new TreesRPanel(bfc, this, trees));						panel.setLocation(0,0);						}					}				}			}		}		resetSizes(getBounds().width, getBounds().height);	}}/*======================================================================== */class TaxaPanel extends ElementPanel {	Image im;	public TaxaPanel(BasicFileCoordinator bfc, ClosablePanelContainer container, FileElement element){		super(bfc, container, element);		im = 	MesquiteImage.getImage(bfc.getPath()+ "projectHTML" + MesquiteFile.fileSeparator + "taxaBlockSmall.gif");		setColors(ColorDistribution.veryLightGray, ColorDistribution.veryVeryLightGray, Color.lightGray, Color.black);//		setColors(Color.gray, Color.darkGray, Color.white);//		setColors(ColorDistribution.veryVeryLightGray, Color.gray, Color.darkGray);		addCommand(true, null, "List & Manage Taxa", "List & Manage Taxa", new MesquiteCommand("showMe", element));		addCommand(true, null, "Chart Taxa", "Chart Taxa", new MesquiteCommand("chart", this));		addCommand(true, null, "-", "-", null);		addCommand(true, null, "Rename Taxa Block", "Rename Taxa Block", new MesquiteCommand("renameMe", element));		addCommand(true, null, "Delete Taxa Block", "Delete Taxa Block", new MesquiteCommand("deleteMe", element));		addCommand(true, null, "Edit Comment", "Edit Comment", new MesquiteCommand("editComment", element));	//	addCommand(true, null, "ID " + element.getID(), "ID " + element.getID(), new MesquiteCommand("id", this));	}	void chart(){		String mID = Long.toString(element.getID());		MesquiteThread.addHint(new MesquiteString("TaxonValuesChart", mID));		if (MesquiteDialog.useWizards)			MesquiteThread.triggerWizard();		bfc.showChartWizard("Taxa");		if (MesquiteDialog.useWizards)			MesquiteThread.detriggerWizard();	}	public String getNotes(){		return Integer.toString(((Taxa)element).getNumTaxa()) + " Taxa";	}	public Image getIcon(){ //for small 16 pixel icon at left of main bar		return null; //return im;	}}/*======================================================================== */class MElementPanel extends ElementPanel {	public MElementPanel(BasicFileCoordinator bfc, ClosablePanelContainer container, FileElement element){		super(bfc, container, element);		addCommand(true, null, "Show Character Matrix", "Show Character Matrix", new MesquiteCommand("showMe", element));		addCommand(true, null, "List & Manage Characters", "List & Manage Characters", new MesquiteCommand("list", this));		addCommand(true, null, "Chart Characters", "Chart Characters", new MesquiteCommand("chart", this));		addCommand(true, null, "-", "-", null);		addCommand(true, null, "Rename Character Matrix", "Rename  Character Matrix", new MesquiteCommand("renameMe", element));		addCommand(true, null, "Delete  Character Matrix", "Delete  Character Matrix", new MesquiteCommand("deleteMe", element));		addCommand(true, null, "Edit Comment", "Edit Comment", new MesquiteCommand("editComment", element));		//addCommand(true, null, "ID " + element.getID(), "ID " + element.getID(), new MesquiteCommand("id", this));	}	public Object doCommand(String commandName, String arguments, CommandChecker checker) {		if (checker.compare(this.getClass(), "Lists the characters", null, commandName, "list")) {			((CharacterData)element).showList();		}		else			return  super.doCommand(commandName, arguments, checker);		return null;	}	public String getNotes(){		return Integer.toString(((CharacterData)element).getNumChars()) + " Characters";	}	void chart(){		String mID = Long.toString(element.getID());		String tID = Long.toString(((CharacterData)element).getTaxa().getID());		MesquiteThread.addHint(new MesquiteString("CharacterValuesChart", tID));		MesquiteThread.addHint(new MesquiteString("CharSrcCoordObed", "#StoredCharacters"));		MesquiteThread.addHint(new MesquiteString("StoredCharacters", mID));		if (MesquiteDialog.useWizards)			MesquiteThread.triggerWizard();		bfc.showChartWizard("Characters");		if (MesquiteDialog.useWizards)			MesquiteThread.detriggerWizard();	}}/*======================================================================== */class CategMPanel extends MElementPanel {	Image im;	public CategMPanel(BasicFileCoordinator bfc, ClosablePanelContainer container, FileElement element){		super(bfc, container, element);		im = 	MesquiteImage.getImage(bfc.getPath()+ "projectHTML" + MesquiteFile.fileSeparator + "matrixCategSmall.gif");	}	public Image getIcon(){ //for small 16 pixel icon at left of main bar		return im;	}}/*======================================================================== */class MolecMPanel extends MElementPanel {	Image im;	public MolecMPanel(BasicFileCoordinator bfc, ClosablePanelContainer container, FileElement element){		super(bfc, container, element);		im = 	MesquiteImage.getImage(bfc.getPath()+ "projectHTML" + MesquiteFile.fileSeparator + "matrixMolecSmall.gif");	}	public Image getIcon(){ //for small 16 pixel icon at left of main bar		return im;	}}/*======================================================================== */class ContMPanel extends MElementPanel {	Image im;	public ContMPanel(BasicFileCoordinator bfc, ClosablePanelContainer container, FileElement element){		super(bfc, container, element);		im = 	MesquiteImage.getImage(bfc.getPath()+ "projectHTML" + MesquiteFile.fileSeparator + "matrixContSmall.gif");	}	public Image getIcon(){ //for small 16 pixel icon at left of main bar		return im;	}}/*======================================================================== */class TreesRPanel extends ElementPanel {	Image im;	public TreesRPanel(BasicFileCoordinator bfc, ClosablePanelContainer container, FileElement element){		super(bfc, container, element);		im = 	MesquiteImage.getImage(bfc.getPath()+ "projectHTML" + MesquiteFile.fileSeparator + "treesSmall.gif");		addCommand(true, null, "View Trees", "View Trees", new MesquiteCommand("showTreesInWindow", element));		addCommand(true, null, "List & Manage Trees", "List & Manage Trees", new MesquiteCommand("showMe", element));		addCommand(true, null, "Chart Trees", "Chart Trees", new MesquiteCommand("chart", this));		addCommand(true, null, "-", "-", null);		addCommand(true, null, "Rename Trees Block", "Rename Trees Block", new MesquiteCommand("renameMe", element));		addCommand(true, null, "Delete Trees Block", "Delete Trees Block", new MesquiteCommand("deleteMe", element));		addCommand(true, null, "Edit Comment", "Edit Comment", new MesquiteCommand("editComment", element));	//	addCommand(true, null, "ID " + element.getID(), "ID " + element.getID(), new MesquiteCommand("id", this));	}	void chart(){		String mID = Long.toString(element.getID());		String tID = Long.toString(((TreeVector)element).getTaxa().getID());		MesquiteThread.addHint(new MesquiteString("TreeValuesChart", tID));		MesquiteThread.addHint(new MesquiteString("TreeValuesChart", "#StoredTrees"));		MesquiteThread.addHint(new MesquiteString("StoredTrees", mID));		if (MesquiteDialog.useWizards)			MesquiteThread.triggerWizard();		bfc.showChartWizard("Trees");		if (MesquiteDialog.useWizards)			MesquiteThread.detriggerWizard();	}	public Image getIcon(){ //for small 16 pixel icon at left of main bar		return im;	}	public String getNotes(){		return Integer.toString(((TreeVector)element).size()) + " Trees";	}}/*======================================================================== */class ElementPanel extends ClosablePanel implements MesquiteListener {	FileElement element;	Vector commands = new Vector();	MesquitePopup popup=null;	BasicFileCoordinator bfc;	StringInABox notes;	public ElementPanel(BasicFileCoordinator bfc, ClosablePanelContainer container, FileElement element){		super(container, element.getName());		this.bfc = bfc;		setColors(Color.white, ColorDistribution.veryVeryVeryLightGray, ColorDistribution.veryVeryLightGray, Color.darkGray);//		setColors(ColorDistribution.veryVeryLightGray, ColorDistribution.veryLightGray, Color.darkGray);		this.element = element;		currentHeight = 80;		element.addListener(this);		setTightness(2);		notes =  new StringInABox(getNotes(), new Font("SansSerif", Font.PLAIN, 10), 150);			}	public Image getIcon(){ //for small 16 pixel icon at left of main bar		return null;	}	protected int getFontSize(){		return 10;	}	public void paint(Graphics g){		notes.draw(g,20, MINHEIGHT);		super.paint(g);	}		public String getNotes(){		return "";	}	public void setBounds(int x, int y, int w, int h){		super.setBounds(x,y,w,h);	}	public void setSize(int w, int h){		super.setSize(w,h);			}		protected void addCommand(boolean menuOnly, String iconPath, String label, String shortLabel, MesquiteCommand command){		commands.addElement(new ElementCommand(menuOnly, iconPath, label, shortLabel, command));	}	void chart(){	}	/*.................................................................................................................*/	public Object doCommand(String commandName, String arguments, CommandChecker checker) {		if (checker.compare(this.getClass(), "Charts the file element", null, commandName, "chart")) {			chart();		}		else			return  super.doCommand(commandName, arguments, checker);		return null;	}	public void changed(Object caller, Object obj, Notification notification){		if (obj == element) {			setTitle(element.getName());			notes.setString(getNotes());		repaint();	}	}	public void disposing(Object obj){			}	public boolean okToDispose(Object obj, int queryUser){		return true;	}	public void mouseDown (int modifiers, int clickCount, long when, int x, int y, MesquiteTool tool) {		//if modifiers include right click/control, then do dropdown menu		if (MesquiteEvent.rightClick(modifiers)) {			redoMenu();			popup.show(this, x,y);			return;		}				else if (y<= MINHEIGHT) {			super.mouseDown(modifiers,  clickCount,  when,  x,  y,  tool);			return;		}	}	/*.................................................................................................................*/	void redoMenu() {		if (popup==null)			popup = new MesquitePopup(this);		popup.removeAll();		for (int i=0; i<commands.size(); i++) {			ElementCommand m = (ElementCommand)commands.elementAt(i);			MesquiteMenuItem mItem = new MesquiteMenuItem(m.shortLabel, bfc, m.command);			popup.add(mItem);		}		add(popup);	}	public void mouseUp(int modifiers, int x, int y, MesquiteTool tool) {		if (!MesquiteEvent.rightClick(modifiers) && y<= MINHEIGHT) {			super.mouseUp(modifiers,  x,  y,  tool);			return;		}	}	public void dispose(){		if (popup!=null)			remove(popup);		element.removeListener(this);	}}class ElementCommand {	boolean menuOnly;	String iconPath;	String label;	String shortLabel;	MesquiteCommand command;	public ElementCommand(boolean menuOnly, String iconPath, String label, String shortLabel, MesquiteCommand command){		this.menuOnly =menuOnly;		this.iconPath =iconPath;		this.label =label;		this.shortLabel =shortLabel;		this.command =command;	}}